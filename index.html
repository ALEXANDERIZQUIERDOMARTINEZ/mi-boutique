<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo - Mishell Boutique</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos base si style.css no existe o est치 incompleto */
        :root { --color-primario: #D988B9; --color-primario-claro: #F5E8ED; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .admin-navbar { background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,.05); }
        .admin-brand span { color: var(--color-primario); font-weight: bold; }
        .admin-main { padding: 1.5rem; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,.08); border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .card-header { background-color: white; border-bottom: 1px solid #eee; }
        .btn-primary { background-color: var(--color-primario); border-color: var(--color-primario); }
        .btn-primary:hover { background-color: #c473a2; border-color: #c473a2; }
        .btn-outline-primary { color: var(--color-primario); border-color: var(--color-primario); }
        .btn-outline-primary:hover { background-color: var(--color-primario); color: white; }
        
        /* Estilos espec칤ficos para el cat치logo */
        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,.1);
        }
        .product-card .card-img-top {
            height: 300px; 
            object-fit: cover;
        }
        .product-card .card-body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px; /* Alto m칤nimo para el cuerpo */
        }
        .product-card .card-title {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }
        .product-card .card-price {
            color: var(--color-primario);
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: auto; /* Empuja el precio al fondo */
        }
        .product-card.agotado .card-img-top {
            filter: grayscale(80%);
        }
        .badge.bg-dark {
            z-index: 10;
        }

        /* Estilos Modal Producto */
        #productDetailModal .modal-img {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        #productDetailModal .price-detal {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primario);
        }
        #productDetailModal .price-mayor {
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
        }
        #stock-disponible {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Estilos Carrito */
        .cart-icon {
            font-size: 1.5rem;
            color: #333;
        }
        .cart-badge {
            top: 0;
            right: -5px;
            font-size: 0.6em;
            padding: 0.25em 0.45em;
        }
        .offcanvas-body .cart-item-img {
            width: 50px;
            height: 65px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

    </style>
</head>
<body>

    <nav class="admin-navbar navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="admin-brand navbar-brand" href="index.html"><span>Mishell</span> Boutique</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#publicNavbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="publicNavbarContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-instagram me-1"></i> Instagram</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="bi bi-person-circle me-1"></i> Admin</a>
                    </li>
                    <li class="nav-item ms-2">
                        <a class="nav-link position-relative" href="#" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" id="cart-button">
                            <i class="bi bi-bag cart-icon"></i>
                            <span class="position-absolute translate-middle badge rounded-pill bg-danger cart-badge" id="cart-badge" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="admin-main container">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="h2">Nuestro Cat치logo</h1>
                <p class="text-muted">Productos nuevos cada semana</p>
            </div>
        </div>

        <div class="row g-3 g-md-4" id="lista-productos-publica">
            <div id="loading-products" class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status" style="color: var(--color-primario) !important;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando productos...</p>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 text-muted border-top mt-4">
        <p class="mb-0">&copy; 2025 Mishell Boutique. Todos los derechos reservados.</p>
    </footer>

    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="product-modal-title">Nombre del Producto</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img src="" id="product-modal-img" class="modal-img" alt="Producto">
                        </div>
                        <div class="col-md-6 d-flex flex-column">
                            <p id="product-modal-desc">Descripci칩n del producto...</p>
                            <div class="mt-auto">
                                <p class="price-detal mb-0" id="product-modal-price-detal">$0</p>
                                <p class="price-mayor" id="product-modal-price-mayor">Mayor: $0</p>
                                
                                <input type="hidden" id="product-modal-id">

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label for="select-talla" class="form-label">Talla:</label>
                                        <select class="form-select" id="select-talla" required>
                                            <option value="">Selecciona...</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="select-color" class="form-label">Color:</label>
                                        <select class="form-select" id="select-color" required disabled>
                                            <option value="">Selecciona Talla</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label for="select-cantidad" class="form-label mb-0">Cantidad:</label>
                                    <input type="number" class="form-control w-50" id="select-cantidad" value="1" min="1" max="1">
                                    <span id="stock-disponible" class="text-muted"></span>
                                </div>

                                <button class="btn btn-primary w-100" id="btn-add-to-cart" disabled>
                                    <i class="bi bi-bag-plus-fill me-2"></i>Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="offcanvasLabel"><i class="bi bi-bag me-2"></i>Mi Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cart-items-container">
                <p class="text-center text-muted" id="cart-empty-msg">Tu carrito est치 vac칤o.</p>
            </div>
        </div>
        <div class="offcanvas-footer border-top p-3" id="cart-footer" style="display: none;">
            <p class="d-flex justify-content-between fs-5 fw-bold">
                <span>Total:</span>
                <span id="cart-total">$0</span>
            </p>
            <button class="btn btn-primary w-100" id="btn-whatsapp-order">
                <i class="bi bi-whatsapp me-2"></i> Pedir por WhatsApp
            </button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Importar funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Configuraci칩n de Firebase (LA MISMA que en admin.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBB55I4aWpH5hOtqK6FdNzZCuYCRm1siiI",
            authDomain: "mishell-boutique-admin.firebaseapp.com",
            projectId: "mishell-boutique-admin",
            storageBucket: "mishell-boutique-admin.appspot.com",
            messagingSenderId: "399662956877",
            appId: "1:399662956877:web:084236f5bb3cf6f0a8f704",
            measurementId: "G-TZ3WQ8LSXH"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productsCollection = collection(db, 'productos');

        // Helper: Formato de Moneda
        const formatoMoneda = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0});

        // --- Elementos del DOM ---
        const productListContainer = document.getElementById('lista-productos-publica');
        const loadingEl = document.getElementById('loading-products');
        
        // --- Modal de Producto ---
        const productDetailModalEl = document.getElementById('productDetailModal');
        const productModal = new bootstrap.Modal(productDetailModalEl);
        const modalTitle = document.getElementById('product-modal-title');
        const modalImg = document.getElementById('product-modal-img');
        const modalDesc = document.getElementById('product-modal-desc');
        const modalPriceDetal = document.getElementById('product-modal-price-detal');
        const modalPriceMayor = document.getElementById('product-modal-price-mayor');
        const modalIdInput = document.getElementById('product-modal-id');
        const selectTalla = document.getElementById('select-talla');
        const selectColor = document.getElementById('select-color');
        const selectCantidad = document.getElementById('select-cantidad');
        const stockDisponible = document.getElementById('stock-disponible');
        const btnAddToCart = document.getElementById('btn-add-to-cart');
        
        // --- Carrito ---
        let cart = [];
        let productsMap = new Map(); // Cach칠 de productos
        const cartOffcanvas = new bootstrap.Offcanvas(document.getElementById('cartOffcanvas'));
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const cartFooter = document.getElementById('cart-footer');
        const cartTotalEl = document.getElementById('cart-total');
        const cartBadge = document.getElementById('cart-badge');
        const btnWhatsapp = document.getElementById('btn-whatsapp-order');

        // --- Funci칩n para renderizar productos ---
        const renderProducts = (snapshot) => {
            if (!productListContainer) return;
            productListContainer.innerHTML = ''; 
            productsMap.clear();
            if (loadingEl) loadingEl.style.display = 'none';

            if (snapshot.empty) {
                productListContainer.innerHTML = '<p class="text-center text-muted">No hay productos en el cat치logo por el momento.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const product = doc.data();
                const id = doc.id;
                productsMap.set(id, product); // Guardar en cach칠

                const stockTotal = product.variaciones ? product.variaciones.reduce((sum, v) => sum + (parseInt(v.stock, 10) || 0), 0) : 0;
                const isAgotado = stockTotal <= 0;
                const imagenUrl = product.imagenUrl || 'https://via.placeholder.com/300x300/f0f0f0/cccccc?text=Foto';
                
                const col = document.createElement('div');
                col.className = 'col-lg-3 col-md-4 col-sm-6 col-12';
                
                col.innerHTML = `
                    <div class="card product-card h-100 ${isAgotado ? 'agotado' : ''}" data-bs-toggle="modal" data-bs-target="#productDetailModal" data-product-id="${id}">
                        ${isAgotado ? '<span class="badge bg-dark position-absolute top-0 end-0 m-2">Agotado</span>' : ''}
                        <img src="${imagenUrl}" class="card-img-top" alt="${product.nombre}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.nombre}</h5>
                            <p class="card-price mt-auto">${formatoMoneda.format(product.precioDetal)}</p>
                        </div>
                    </div>
                `;
                
                productListContainer.appendChild(col);
            });
        };

        // --- L칩gica del Modal de Producto ---
        productDetailModalEl.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const productId = button.dataset.productId;
            const product = productsMap.get(productId);

            if (!product) {
                console.error("Producto no encontrado en el cach칠");
                return;
            }

            // Resetear modal
            modalTitle.textContent = product.nombre;
            modalImg.src = product.imagenUrl || 'https://via.placeholder.com/400x400/f0f0f0/cccccc?text=Foto';
            modalDesc.textContent = product.descripcion || 'Sin descripci칩n.';
            modalPriceDetal.textContent = formatoMoneda.format(product.precioDetal);
            modalPriceMayor.textContent = `Mayor: ${formatoMoneda.format(product.precioMayor)}`;
            modalIdInput.value = productId;
            
            // Resetear selects
            selectTalla.innerHTML = '<option value="">Selecciona Talla...</option>';
            selectColor.innerHTML = '<option value="">Selecciona Talla</option>';
            selectColor.disabled = true;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            selectCantidad.value = 1;
            selectCantidad.max = 1;

            // Poblar Tallas
            const variaciones = product.variaciones || [];
            const tallasUnicas = [...new Set(variaciones.map(v => v.talla).filter(Boolean))]; // Filtra tallas vac칤as
            
            if (tallasUnicas.length === 0 && variaciones.length > 0) {
                // Caso: Producto sin talla (ej. solo color)
                selectTalla.innerHTML = '<option value="unica">Talla 칔nica</option>';
                selectTalla.value = "unica";
                selectTalla.dispatchEvent(new Event('change')); // Disparar cambio
            } else {
                tallasUnicas.forEach(talla => {
                    selectTalla.innerHTML += `<option value="${talla}">${talla}</option>`;
                });
            }
        });

        // --- L칩gica Talla -> Color -> Stock ---
        selectTalla.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla) return;

            // Resetear color y bot칩n
            selectColor.innerHTML = '<option value="">Selecciona Color...</option>';
            selectColor.disabled = false;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            
            const variaciones = product.variaciones || [];
            let coloresDisponibles = [];

            if (selectedTalla === 'unica') {
                coloresDisponibles = [...new Set(variaciones.map(v => v.color).filter(Boolean))];
            } else {
                coloresDisponibles = [...new Set(variaciones
                    .filter(v => v.talla === selectedTalla)
                    .map(v => v.color)
                    .filter(Boolean)
                )];
            }
            
            if (coloresDisponibles.length === 0 && variaciones.length > 0) {
                 // Caso: Producto sin color (ej. solo talla)
                 selectColor.innerHTML = '<option value="unico">Color 칔nico</option>';
                 selectColor.value = "unico";
                 selectColor.dispatchEvent(new Event('change')); // Disparar cambio
            } else {
                coloresDisponibles.forEach(color => {
                    selectColor.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }
        });

        selectColor.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla || !selectedColor) return;
            
            const variaciones = product.variaciones || [];
            
            // Encontrar la variaci칩n exacta
            let variacion;
            if(selectedTalla === 'unica' && selectedColor === 'unico') {
                variacion = variaciones[0];
            } else if (selectedTalla === 'unica') {
                variacion = variaciones.find(v => v.color === selectedColor);
            } else if (selectedColor === 'unico') {
                variacion = variaciones.find(v => v.talla === selectedTalla);
            } else {
                variacion = variaciones.find(v => v.talla === selectedTalla && v.color === selectedColor);
            }
            
            if (variacion && variacion.stock > 0) {
                stockDisponible.textContent = `${variacion.stock} disponibles`;
                stockDisponible.className = "text-success";
                selectCantidad.max = variacion.stock;
                selectCantidad.value = 1;
                btnAddToCart.disabled = false;
            } else {
                stockDisponible.textContent = 'Agotado';
                stockDisponible.className = "text-danger";
                selectCantidad.max = 0;
                selectCantidad.value = 0;
                btnAddToCart.disabled = true;
            }
        });
        
        // --- L칩gica del Carrito ---
        
        function addToCart() {
            const product = productsMap.get(modalIdInput.value);
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const cantidad = parseInt(selectCantidad.value, 10);
            
            if (!product || !selectedTalla || !selectedColor || cantidad <= 0) {
                showToast("Por favor selecciona talla, color y cantidad.", 'warning');
                return;
            }

            // Crear un ID 칰nico para el item del carrito (producto + talla + color)
            const cartItemId = `${product.id}-${selectedTalla}-${selectedColor}`;
            const existingItem = cart.find(item => item.cartItemId === cartItemId);
            
            const variacion = product.variaciones.find(v => 
                (v.talla || 'unica') === selectedTalla && 
                (v.color || 'unico') === selectedColor
            );
            
            const stock = variacion ? variacion.stock : 0;
            
            if (existingItem) {
                if (existingItem.cantidad + cantidad > stock) {
                    showToast(`No puedes agregar m치s. Solo hay ${stock} en stock.`, 'warning');
                    return;
                }
                existingItem.cantidad += cantidad;
                existingItem.total = existingItem.cantidad * existingItem.precio;
            } else {
                if (cantidad > stock) {
                    showToast(`No puedes agregar ${cantidad}. Solo hay ${stock} en stock.`, 'warning');
                    return;
                }
                cart.push({
                    cartItemId: cartItemId,
                    id: product.id,
                    nombre: product.nombre,
                    precio: product.precioDetal,
                    talla: selectedTalla,
                    color: selectedColor,
                    cantidad: cantidad,
                    total: cantidad * product.precioDetal,
                    imagenUrl: product.imagenUrl
                });
            }
            
            showToast(`${product.nombre} (${selectedTalla}/${selectedColor}) a침adido al carrito!`, 'success');
            productModal.hide();
            renderCart();
        }
        
        function renderCart() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-muted" id="cart-empty-msg">Tu carrito est치 vac칤o.</p>';
                cartFooter.style.display = 'none';
                cartBadge.style.display = 'none';
            } else {
                cartEmptyMsg.style.display = 'none';
                cartFooter.style.display = 'block';
                cartItemsContainer.innerHTML = '';
                let totalGeneral = 0;
                let itemCount = 0;
                
                cart.forEach((item, index) => {
                    cartItemsContainer.innerHTML += `
                        <div class="d-flex align-items-center mb-3">
                            <img src="${item.imagenUrl || 'https://via.placeholder.com/50x65'}" alt="${item.nombre}" class="cart-item-img me-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fs-sm">${item.nombre}</h6>
                                <small class="text-muted d-block">${item.talla} / ${item.color}</small>
                                <span class="fw-bold fs-sm">${formatoMoneda.format(item.precio)} x ${item.cantidad}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger btn-remove-from-cart" data-index="${index}" style="line-height: 1; padding: 0.2rem 0.4rem;">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    `;
                    totalGeneral += item.total;
                    itemCount += item.cantidad;
                });
                
                cartTotalEl.textContent = formatoMoneda.format(totalGeneral);
                cartBadge.textContent = itemCount;
                cartBadge.style.display = 'block';
            }
        }
        
        // Evento para el bot칩n de Agregar al Carrito
        btnAddToCart.addEventListener('click', addToCart);

        // Evento para remover items del carrito
        cartItemsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.btn-remove-from-cart');
            if (target) {
                e.preventDefault();
                const index = parseInt(target.dataset.index, 10);
                cart.splice(index, 1); // Quitar el item del array
                renderCart(); // Volver a dibujar el carrito
            }
        });
        
        // Evento para Pedido por WhatsApp
        btnWhatsapp.addEventListener('click', (e) => {
            e.preventDefault();
            let mensaje = "춰Hola Mishell Boutique! 游녦 Me gustar칤a pedir lo siguiente:\n\n";
            cart.forEach(item => {
                mensaje += `*Producto:* ${item.nombre}\n`;
                mensaje += `*Talla:* ${item.talla}\n`;
                mensaje += `*Color:* ${item.color}\n`;
                mensaje += `*Cantidad:* ${item.cantidad}\n`;
                mensaje += `*Subtotal:* ${formatoMoneda.format(item.total)}\n`;
                mensaje += `---------------------\n`;
            });
            const totalGeneral = cart.reduce((sum, item) => sum + item.total, 0);
            mensaje += `\n*TOTAL DEL PEDIDO: ${formatoMoneda.format(totalGeneral)}*`;
            
            // Reemplaza 'TU_NUMERO' con tu n칰mero de WhatsApp con c칩digo de pa칤s (ej. 573046084971)
            const numeroWhatsapp = "573046084971"; 
            const url = `https://wa.me/${numeroWhatsapp}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        });

        // --- Crear la consulta a Firebase ---
        // (La consulta que requiere el 칤ndice que debes crear)
        const q = query(productsCollection, 
                        where("visible", "==", true), 
                        orderBy("timestamp", "desc")
                    );

        // --- Escuchar cambios en tiempo real ---
        onSnapshot(q, renderProducts, (error) => {
            console.error("Error al cargar productos: ", error);
            if (loadingEl) loadingEl.style.display = 'none';
            // Mensaje de error amigable que incluye el enlace para crear el 칤ndice
            if (error.code === 'failed-precondition') {
                 productListContainer.innerHTML = `<div class="col-12 text-center text-danger">
                    <p><strong>Error de base de datos.</strong></p>
                    <p>Parece que falta un 칤ndice de Firestore. Por favor, abre la consola (F12) y haz clic en el enlace que aparece en el error rojo para crearlo autom치ticamente.</p>
                 </div>`;
            } else {
                productListContainer.innerHTML = `<p class="text-center text-danger">Error al cargar los productos.</p>`;
            }
        });

    </script>

</body>
</html>
