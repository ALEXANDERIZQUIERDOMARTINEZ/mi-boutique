<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo - Mishell Boutique</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos base si style.css no existe o est치 incompleto */
        :root { --color-primario: #D988B9; --color-primario-claro: #F5E8ED; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .admin-navbar { background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,.05); }
        .admin-brand span { color: var(--color-primario); font-weight: bold; }
        .admin-main { padding-top: 1rem; padding-bottom: 1rem; } /* Menos padding para m칩vil */
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,.06); border-radius: 0.5rem; margin-bottom: 1rem; }
        .btn-primary { background-color: var(--color-primario); border-color: var(--color-primario); }
        .btn-primary:hover { background-color: #c473a2; border-color: #c473a2; }
        .btn-outline-primary { color: var(--color-primario); border-color: var(--color-primario); }
        .btn-outline-primary:hover { background-color: var(--color-primario); color: white; }
        
        /* Estilos espec칤ficos para el cat치logo (Mobile-First) */
        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,.1);
        }
        .product-card .card-img-top {
            height: 200px; /* Altura optimizada para grid m칩vil */
            object-fit: contain; /* Muestra la imagen completa */
            background-color: #fff; /* Fondo blanco para im치genes no cuadradas */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            padding: 0.25rem; /* Peque침o padding */
        }
        .product-card .card-body {
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
        }
        .product-card .card-title {
            font-weight: 600;
            font-size: 0.9rem; /* M치s peque침o para m칩vil */
            color: #333;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        .product-card .card-price-detal {
            color: var(--color-primario);
            font-size: 1.1rem;
            font-weight: bold;
        }
        .product-card .card-price-mayor {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .product-card .card-variations {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
            margin-bottom: 0.5rem;
            min-height: 18px; /* Espacio reservado */
        }
        .product-card.agotado .card-img-top {
            filter: grayscale(80%);
        }
        .badge.bg-dark {
            z-index: 10;
            font-size: 0.7em;
        }
        
        /* Media query para pantallas m치s grandes */
        @media (min-width: 768px) {
            .admin-main { padding: 1.5rem; }
            .product-card .card-img-top {
                height: 300px; /* M치s altura en pantallas grandes */
            }
            .product-card .card-body {
                padding: 1rem;
            }
            .product-card .card-title {
                font-size: 1rem;
            }
        }

        /* === ESTILOS MODALES (Sobrio y Cl치sico) === */
        .modal-content, .offcanvas-content {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
        }
        .modal-header, .offcanvas-header {
            background-color: var(--color-primario-claro); /* Rosa p치lido */
            color: var(--color-primario); /* Rosa oscuro */
            border-bottom: none; 
        }
        .modal-header .btn-close, .offcanvas-header .btn-close { filter: none; }
        .modal-footer, .offcanvas-footer { border-top: 1px solid #eee; }

        /* Estilos Modal Producto */
        #productDetailModal .modal-img {
            width: 100%;
            height: 400px;
            object-fit: contain; /* Imagen completa tambi칠n en modal */
            background-color: #fff;
            border-radius: 0.5rem;
        }
        #productDetailModal .price-detal {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primario);
        }
        #productDetailModal .price-mayor {
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
        }
        #stock-disponible {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Estilos Carrito */
        .cart-icon {
            font-size: 1.5rem;
            color: #333;
        }
        .cart-badge {
            top: 0;
            right: -5px;
            font-size: 0.6em;
            padding: 0.25em 0.45em;
        }
        .offcanvas-body .cart-item-img {
            width: 50px;
            height: 65px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>

    <nav class="admin-navbar navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="admin-brand navbar-brand" href="index.html"><span>Mishell</span> Boutique</a>
            
            <a class="nav-link position-relative ms-auto" href="#" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" id="cart-button-mobile">
                <i class="bi bi-bag cart-icon"></i>
                <span class="position-absolute translate-middle badge rounded-pill bg-danger cart-badge" id="cart-badge" style="display: none;">0</span>
            </a>
            
            <button class="navbar-toggler d-none" type="button" data-bs-toggle="collapse" data-bs-target="#publicNavbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="publicNavbarContent">
                </div>
        </div>
    </nav>

    <main class="admin-main container">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="h2">Nuestro Cat치logo</h1>
                <p class="text-muted">Productos nuevos cada semana</p>
            </div>
        </div>

        <div class="row g-3" id="lista-productos-publica">
            <div id="loading-products" class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status" style="color: var(--color-primario) !important;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando productos...</p>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 text-muted border-top mt-4">
        <p class="mb-0">&copy; 2024 Mishell Boutique. Todos los derechos reservados.</p>
    </footer>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-body"> Mensaje. </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="product-modal-title">Nombre del Producto</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <img src="" id="product-modal-img" class="modal-img" alt="Producto">
                        </div>
                        <div class="col-md-6 d-flex flex-column">
                            <p id="product-modal-desc">Descripci칩n del producto...</p>
                            <div class="mt-auto">
                                <p class="price-detal mb-0" id="product-modal-price-detal">$0</p>
                                <p class="price-mayor" id="product-modal-price-mayor">Mayor: $0</p>
                                
                                <input type="hidden" id="product-modal-id">

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label for="select-talla" class="form-label">Talla:</label>
                                        <select class="form-select" id="select-talla" required>
                                            <option value="">Selecciona...</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="select-color" class="form-label">Color:</label>
                                        <select class="form-select" id="select-color" required disabled>
                                            <option value="">Selecciona Talla</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label for="select-cantidad" class="form-label mb-0">Cantidad:</label>
                                    <input type="number" class="form-control w-50" id="select-cantidad" value="1" min="1" max="1">
                                    <span id="stock-disponible" class="text-muted"></span>
                                </div>

                                <button class="btn btn-primary w-100" id="btn-add-to-cart" disabled>
                                    <i class="bi bi-bag-plus-fill me-2"></i>Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel"><i class="bi bi-bag me-2"></i>Mi Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cart-items-container">
                <p class="text-center text-muted" id="cart-empty-msg">Tu carrito est치 vac칤o.</p>
            </div>
        </div>
        <div class="offcanvas-footer border-top p-3" id="cart-footer" style="display: none;">
            <p class="d-flex justify-content-between fs-5 fw-bold">
                <span>Total:</span>
                <span id="cart-total">$0</span>
            </p>
            <button class="btn btn-primary w-100" id="btn-checkout" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                <i class="bi bi-bag-check-fill me-2"></i> Continuar Pedido
            </button>
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Finalizar Pedido</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-checkout">
                        <div class="mb-3">
                            <label for="checkout-nombre" class="form-label">Nombre Completo:</label>
                            <input type="text" class="form-control" id="checkout-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-whatsapp" class="form-label">N칰mero de WhatsApp:</label>
                            <input type="tel" class="form-control" id="checkout-whatsapp" placeholder="Ej: 3001234567" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-direccion" class="form-label">Direcci칩n de Env칤o:</label>
                            <input type="text" class="form-control" id="checkout-direccion" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-observaciones" class="form-label">Observaciones (ej. c칩mo llegar, apto, etc.):</label>
                            <textarea class="form-control" id="checkout-observaciones" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-pago" class="form-label">M칠todo de Pago:</label>
                            <select class="form-select" id="checkout-pago" required>
                                <option value="">Selecciona...</option>
                                <option value="Efectivo">Efectivo (Pago contra entrega)</option>
                                <option value="Transferencia">Transferencia (Nequi/Bancolombia)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver al Carrito</button>
                    <button type="submit" class="btn btn-primary" id="btn-confirm-order" form="form-checkout">
                        <i class="bi bi-whatsapp me-2"></i>Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Importar funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Configuraci칩n de Firebase (LA MISMA que en admin.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBB55I4aWpH5hOtqK6FdNzZCuYCRm1siiI",
            authDomain: "mishell-boutique-admin.firebaseapp.com",
            projectId: "mishell-boutique-admin",
            storageBucket: "mishell-boutique-admin.appspot.com",
            messagingSenderId: "399662956877",
            appId: "1:399662956877:web:084236f5bb3cf6f0a8f704",
            measurementId: "G-TZ3WQ8LSXH"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productsCollection = collection(db, 'productos');
        const webOrdersCollection = collection(db, 'pedidosWeb'); // <-- NUEVA COLECCI칍N

        // Helper: Formato de Moneda
        const formatoMoneda = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0});

        // --- Helper: Show Toast Notification ---
        let bsToast = null;
        function showToast(message, type = 'success', title = 'Notificaci칩n') {
            const liveToastEl = document.getElementById('liveToast');
            const toastBodyEl = document.getElementById('toast-body');
            
            if (liveToastEl && toastBodyEl) {
                if (!bsToast) { try { bsToast = new bootstrap.Toast(liveToastEl, { delay: 4000 }); } catch (e) { console.error("Toast init error", e); return; }}
                liveToastEl.className = 'toast align-items-center border-0'; // Reset classes
                const bgClass = type === 'error' ? 'text-bg-danger' : (type === 'warning' ? 'text-bg-warning' : (type === 'info' ? 'text-bg-info' : 'text-bg-success'));
                liveToastEl.classList.add(bgClass, 'text-white');
                let iconClass = type === 'success' ? 'bi-check-circle-fill' : (type === 'error' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill');
                toastBodyEl.innerHTML = `<i class="bi ${iconClass} me-2"></i> ${message}`;
                bsToast.show();
            } else { console.warn("Toast elements not found:", message); alert(`${type.toUpperCase()}: ${message}`); }
        }

        // --- Elementos del DOM ---
        const productListContainer = document.getElementById('lista-productos-publica');
        const loadingEl = document.getElementById('loading-products');
        
        // --- Modal de Producto ---
        const productDetailModalEl = document.getElementById('productDetailModal');
        const productModal = new bootstrap.Modal(productDetailModalEl);
        const modalTitle = document.getElementById('product-modal-title');
        const modalImg = document.getElementById('product-modal-img');
        const modalDesc = document.getElementById('product-modal-desc');
        const modalPriceDetal = document.getElementById('product-modal-price-detal');
        const modalPriceMayor = document.getElementById('product-modal-price-mayor');
        const modalIdInput = document.getElementById('product-modal-id');
        const selectTalla = document.getElementById('select-talla');
        const selectColor = document.getElementById('select-color');
        const selectCantidad = document.getElementById('select-cantidad');
        const stockDisponible = document.getElementById('stock-disponible');
        const btnAddToCart = document.getElementById('btn-add-to-cart');
        
        // --- Carrito ---
        let cart = [];
        let productsMap = new Map(); // Cach칠 de productos
        const cartOffcanvasEl = document.getElementById('cartOffcanvas');
        const cartOffcanvas = new bootstrap.Offcanvas(cartOffcanvasEl);
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const cartFooter = document.getElementById('cart-footer');
        const cartTotalEl = document.getElementById('cart-total');
        const cartBadge = document.getElementById('cart-badge'); // Badge unificado
        
        // --- Checkout ---
        const checkoutModalEl = document.getElementById('checkoutModal');
        const checkoutModal = new bootstrap.Modal(checkoutModalEl);
        const formCheckout = document.getElementById('form-checkout');

        // --- Funci칩n para renderizar productos ---
        const renderProducts = (snapshot) => {
            if (!productListContainer) return;
            productListContainer.innerHTML = ''; 
            productsMap.clear();
            if (loadingEl) loadingEl.style.display = 'none';

            if (snapshot.empty) {
                productListContainer.innerHTML = '<p class="text-center text-muted">No hay productos en el cat치logo por el momento.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const product = doc.data();
                const id = doc.id;
                productsMap.set(id, product); // Guardar en cach칠

                const stockTotal = (product.variaciones || []).reduce((sum, v) => sum + (parseInt(v.stock, 10) || 0), 0);
                const isAgotado = stockTotal <= 0;
                const imagenUrl = product.imagenUrl || 'https://via.placeholder.com/300x300/f0f0f0/cccccc?text=Foto';
                
                const tallasUnicas = [...new Set((product.variaciones || []).map(v => v.talla).filter(Boolean))];
                const coloresUnicos = [...new Set((product.variaciones || []).map(v => v.color).filter(Boolean))];
                let variationsText = [tallasUnicas.length > 0 ? 'Tallas' : '', coloresUnicos.length > 0 ? 'Colores' : ''].filter(Boolean).join(' y ');
                if (variationsText) variationsText += " disponibles";

                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3'; // 2 columnas en m칩vil
                
                col.innerHTML = `
                    <div class="card product-card h-100 ${isAgotado ? 'agotado' : ''}" data-bs-toggle="modal" data-bs-target="#productDetailModal" data-product-id="${id}">
                        ${isAgotado ? '<span class="badge bg-dark position-absolute top-0 end-0 m-2">Agotado</span>' : ''}
                        <img src="${imagenUrl}" class="card-img-top" alt="${product.nombre}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.nombre}</h5>
                            <small class="card-variations">${variationsText || '&nbsp;'}</small>
                            <div class="mt-auto">
                                <p class="card-price-mayor mb-0">${formatoMoneda.format(product.precioMayor || 0)} (Mayor)</p>
                                <p class="card-price-detal mb-0">${formatoMoneda.format(product.precioDetal)} (Detal)</p>
                            </div>
                        </div>
                    </div>
                `;
                
                productListContainer.appendChild(col);
            });
        };

        // --- L칩gica del Modal de Producto ---
        productDetailModalEl.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const productId = button.dataset.productId;
            const product = productsMap.get(productId);

            if (!product) { console.error("Producto no encontrado"); return; }

            // Llenar info
            modalTitle.textContent = product.nombre;
            modalImg.src = product.imagenUrl || 'https://via.placeholder.com/400x400/f0f0f0/cccccc?text=Foto';
            modalDesc.textContent = product.descripcion || 'Sin descripci칩n.';
            modalPriceDetal.textContent = formatoMoneda.format(product.precioDetal);
            modalPriceMayor.textContent = `Mayor: ${formatoMoneda.format(product.precioMayor)}`;
            modalIdInput.value = productId;
            
            // Resetear selects y bot칩n
            selectTalla.innerHTML = '<option value="">Selecciona Talla...</option>';
            selectColor.innerHTML = '<option value="">Selecciona Color</option>';
            selectColor.disabled = true;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            selectCantidad.value = 1;
            selectCantidad.max = 1;

            const variaciones = product.variaciones || [];
            const tallasUnicas = [...new Set(variaciones.map(v => v.talla).filter(Boolean))];
            const coloresUnicos = [...new Set(variaciones.map(v => v.color).filter(Boolean))];

            // L칩gica para poblar Tallas
            if (tallasUnicas.length === 0 && variaciones.length > 0) {
                selectTalla.innerHTML = '<option value="unica">칔nica</option>';
                selectTalla.value = "unica";
            } else {
                tallasUnicas.forEach(talla => {
                    selectTalla.innerHTML += `<option value="${talla}">${talla}</option>`;
                });
            }

            // L칩gica para poblar Colores
            if (coloresUnicos.length === 0 && variaciones.length > 0) {
                selectColor.innerHTML = '<option value="unico">칔nico</option>';
                selectColor.value = "unico";
                selectColor.disabled = false;
            } else {
                if (tallasUnicas.length > 0) {
                    selectColor.disabled = true; // Esperar a que se seleccione talla
                } else {
                    // Si NO hay tallas, pero S칈 colores
                    selectColor.innerHTML = '<option value="">Selecciona Color...</option>';
                    coloresUnicos.forEach(color => {
                        selectColor.innerHTML += `<option value="${color}">${color}</option>`;
                    });
                    selectColor.disabled = false;
                }
            }
            
            // Si no hay variaciones de talla ni color (solo stock general)
            if (tallasUnicas.length === 0 && coloresUnicos.length === 0 && variaciones.length > 0) {
                selectTalla.value = "unica";
                selectColor.value = "unico";
                selectColor.disabled = false;
                selectColor.dispatchEvent(new Event('change'));
            } else if (tallasUnicas.length === 0) { // Si solo talla es 칰nica
                 selectTalla.dispatchEvent(new Event('change')); // Disparar para poblar colores
            }
        });

        // --- L칩gica Talla -> Color -> Stock ---
        selectTalla.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla) return;

            selectColor.innerHTML = '<option value="">Selecciona Color...</option>';
            selectColor.disabled = false;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            
            const variaciones = product.variaciones || [];
            const coloresParaTalla = [...new Set(variaciones
                .filter(v => (v.talla || 'unica') === selectedTalla)
                .map(v => v.color)
                .filter(Boolean)
            )];

            if (coloresParaTalla.length === 0) {
                selectColor.innerHTML = '<option value="unico">칔nico</option>';
                selectColor.value = "unico";
                selectColor.dispatchEvent(new Event('change'));
            } else {
                coloresParaTalla.forEach(color => {
                    selectColor.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }
        });

        selectColor.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla || !selectedColor) return;
            
            const variaciones = product.variaciones || [];
            
            const variacion = variaciones.find(v => 
                (v.talla || 'unica') === selectedTalla && 
                (v.color || 'unico') === selectedColor
            );
            
            if (variacion && variacion.stock > 0) {
                stockDisponible.textContent = `${variacion.stock} disponibles`;
                stockDisponible.className = "text-success";
                selectCantidad.max = variacion.stock;
                selectCantidad.value = 1;
                btnAddToCart.disabled = false;
            } else {
                stockDisponible.textContent = 'Agotado';
                stockDisponible.className = "text-danger";
                selectCantidad.max = 0;
                selectCantidad.value = 0;
                btnAddToCart.disabled = true;
            }
        });
        
        // --- L칩gica del Carrito ---
        
        function addToCart(e) {
            e.preventDefault(); 
            const product = productsMap.get(modalIdInput.value);
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const cantidad = parseInt(selectCantidad.value, 10);
            
            if (!product || !selectedTalla || !selectedColor || cantidad <= 0) {
                showToast("Por favor selecciona talla, color y cantidad.", 'warning');
                return;
            }
            
            const variacion = product.variaciones.find(v => 
                (v.talla || 'unica') === selectedTalla && 
                (v.color || 'unico') === selectedColor
            );
            const stock = variacion ? parseInt(variacion.stock, 10) : 0;
            
            // --- VALIDACI칍N DE STOCK ---
            if (cantidad > stock) {
                 showToast(`No puedes agregar ${cantidad}. Solo hay ${stock} en stock.`, 'warning');
                 selectCantidad.value = stock; // Auto-corregir
                 return;
            }

            const cartItemId = `${product.id}-${selectedTalla}-${selectedColor}`;
            const existingItem = cart.find(item => item.cartItemId === cartItemId);
            
            if (existingItem) {
                if (existingItem.cantidad + cantidad > stock) {
                    showToast(`Ya tienes ${existingItem.cantidad} en el carrito. No puedes agregar ${cantidad} m치s. Solo hay ${stock} en stock.`, 'warning');
                    return;
                }
                existingItem.cantidad += cantidad;
                existingItem.total = existingItem.cantidad * existingItem.precio;
            } else {
                cart.push({
                    cartItemId: cartItemId,
                    id: product.id,
                    codigo: product.codigo || 'N/A', // <-- C칍DIGO A칌ADIDO
                    nombre: product.nombre,
                    precio: product.precioDetal, 
                    talla: selectedTalla === 'unica' ? '칔nica' : selectedTalla,
                    color: selectedColor === 'unico' ? '칔nico' : selectedColor,
                    cantidad: cantidad,
                    total: cantidad * product.precioDetal,
                    imagenUrl: product.imagenUrl
                });
            }
            
            showToast(`${product.nombre} (${selectedTalla}/${selectedColor}) a침adido al carrito!`, 'success');
            productModal.hide();
            renderCart();
            cartOffcanvas.show(); // Mostrar carrito al agregar
        }
        
        function renderCart() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-muted" id="cart-empty-msg">Tu carrito est치 vac칤o.</p>';
                cartFooter.style.display = 'none';
                cartBadge.style.display = 'none';
            } else {
                cartEmptyMsg.style.display = 'none';
                cartFooter.style.display = 'block';
                cartItemsContainer.innerHTML = '';
                let totalGeneral = 0;
                let itemCount = 0;
                
                cart.forEach((item, index) => {
                    cartItemsContainer.innerHTML += `
                        <div class="d-flex align-items-center mb-3">
                            <img src="${item.imagenUrl || 'https://via.placeholder.com/50x65'}" alt="${item.nombre}" class="cart-item-img me-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fs-sm">${item.nombre}</h6>
                                <small class="text-muted d-block">${item.talla} / ${item.color}</small>
                                <span class="fw-bold fs-sm">${formatoMoneda.format(item.precio)} x ${item.cantidad}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger btn-remove-from-cart" data-index="${index}" style="line-height: 1; padding: 0.2rem 0.4rem;">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    `;
                    totalGeneral += item.total;
                    itemCount += item.cantidad;
                });
                
                cartTotalEl.textContent = formatoMoneda.format(totalGeneral);
                cartBadge.textContent = itemCount;
                cartBadge.style.display = 'block';
            }
        }
        
        function clearCart() {
            cart = [];
            renderCart();
        }

        // Evento para el bot칩n de Agregar al Carrito
        btnAddToCart.addEventListener('click', addToCart);

        // Evento para remover items del carrito
        cartItemsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.btn-remove-from-cart');
            if (target) {
                e.preventDefault();
                const index = parseInt(target.dataset.index, 10);
                cart.splice(index, 1); // Quitar el item del array
                renderCart(); // Volver a dibujar el carrito
            }
        });
        
        // Evento para Confirmar Pedido (Formulario de Checkout)
        if (formCheckout) {
            formCheckout.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btnConfirm = document.getElementById('btn-confirm-order');
                btnConfirm.disabled = true;
                
                const nombre = document.getElementById('checkout-nombre').value;
                const whatsapp = document.getElementById('checkout-whatsapp').value;
                const direccion = document.getElementById('checkout-direccion').value;
                const observaciones = document.getElementById('checkout-observaciones').value;
                const pago = document.getElementById('checkout-pago').value;
                
                if (!nombre || !whatsapp || !direccion || !pago) {
                    showToast("Por favor completa todos los campos.", 'warning');
                    btnConfirm.disabled = false;
                    return;
                }
                
                const totalGeneral = cart.reduce((sum, item) => sum + item.total, 0);

                // *** PASO A: Guardar el pedido en Firebase ***
                const pedidoData = {
                    datosCliente: {
                        nombre: nombre,
                        whatsapp: whatsapp,
                        direccion: direccion,
                        observaciones: observaciones,
                        metodoPago: pago,
                    },
                    items: cart, // El carrito completo
                    totalPedido: totalGeneral,
                    estado: "pendiente", // Estado inicial
                    timestamp: serverTimestamp()
                };

                try {
                    // Guardar en la nueva colecci칩n
                    await addDoc(webOrdersCollection, pedidoData);
                    
                    // *** PASO B: Generar mensaje de WhatsApp ***
                    let mensaje = "춰Hola Mishell Boutique! 游녦 Me gustar칤a confirmar mi pedido:\n\n";
                    mensaje += "*DATOS DE ENV칈O:*\n";
                    mensaje += `*Nombre:* ${nombre}\n`;
                    mensaje += `*WhatsApp:* ${whatsapp}\n`;
                    mensaje += `*Direcci칩n:* ${direccion}\n`;
                    if(observaciones) mensaje += `*Obs:* ${observaciones}\n`;
                    mensaje += `*Pago:* ${pago}\n`;
                    mensaje += `---------------------\n`;
                    mensaje += "*PRODUCTOS:*\n\n";

                    cart.forEach(item => {
                        mensaje += `*${item.nombre}*\n`;
                        mensaje += `(C칩d: ${item.codigo})\n`;
                        mensaje += `Talla: ${item.talla} / Color: ${item.color}\n`;
                        mensaje += `Cant: ${item.cantidad} x ${formatoMoneda.format(item.precio)} = ${formatoMoneda.format(item.total)}\n`;
                        mensaje += `---------------------\n`;
                    });
                    
                    mensaje += `\n*TOTAL DEL PEDIDO: ${formatoMoneda.format(totalGeneral)}*`;
                    
                    const numeroWhatsapp = "573046084971"; 
                    const url = `https://wa.me/${numeroWhatsapp}?text=${encodeURIComponent(mensaje)}`;
                    
                    // Abrir WhatsApp
                    window.open(url, '_blank');
                    
                    // Limpiar todo
                    checkoutModal.hide();
                    cartOffcanvas.hide();
                    clearCart();
                    formCheckout.reset();
                    showToast("춰Pedido enviado! Tu pedido est치 en revisi칩n.", 'success');

                } catch (err) {
                    console.error("Error al guardar pedido: ", err);
                    showToast("Error al guardar el pedido. Por favor, int칠ntalo de nuevo.", 'error');
                } finally {
                    btnConfirm.disabled = false;
                }
            });
        }


        // --- Crear la consulta a Firebase ---
        // (Aseg칰rate de crear este 칤ndice en tu consola de Firebase)
        const q = query(productsCollection, 
                        where("visible", "==", true), 
                        orderBy("timestamp", "desc")
                    );

        // --- Escuchar cambios en tiempo real ---
        onSnapshot(q, renderProducts, (error) => {
            console.error("Error al cargar productos: ", error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (error.code === 'failed-precondition') {
                 productListContainer.innerHTML = `<div class="col-12 text-center text-danger">
                    <p><strong>Error de base de datos.</strong></p>
                    <p>Falta un 칤ndice de Firestore. Abre la consola (F12) y haz clic en el enlace del error para crearlo.</p>
                 </div>`;
            } else {
                productListContainer.innerHTML = `<p class="text-center text-danger">Error al cargar los productos.</p>`;
            }
        });

    </script>

</body>
</html>
