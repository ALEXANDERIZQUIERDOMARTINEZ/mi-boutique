<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo - Mishell Boutique</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --color-primario: #D988B9; --color-primario-claro: #F5E8ED; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        .admin-navbar { background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,.05); }
        .admin-brand span { color: var(--color-primario); font-weight: bold; }
        .admin-main { padding-top: 1rem; padding-bottom: 1rem; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,.06); border-radius: 0.5rem; margin-bottom: 1rem; }
        .btn-primary { background-color: var(--color-primario); border-color: var(--color-primario); }
        .btn-primary:hover { background-color: #c473a2; border-color: #c473a2; }
        .product-card { transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; height: 100%; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,.1); }
        .product-card .card-img-top { height: 200px; object-fit: contain; background-color: #fff; padding: 0.25rem; }
        .toast-container { z-index: 1100; top: 20px !important; left: 20px !important; }
        @media (min-width: 768px) { .product-card .card-img-top { height: 300px; } }
    </style>
</head>
<body>
    <nav class="admin-navbar navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="admin-brand navbar-brand" href="index.html"><span>Mishell</span> Boutique</a>
            <a class="nav-link position-relative ms-auto" href="#" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
                <i class="bi bi-bag" style="font-size: 1.5rem;"></i>
                <span class="position-absolute translate-middle badge rounded-pill bg-danger" id="cart-badge" style="display: none; top: 0; right: -5px; font-size: 0.6em;">0</span>
            </a>
        </div>
    </nav>

    <main class="admin-main container">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="h2">Nuestro Cat√°logo</h1>
                <p class="text-muted">Productos nuevos cada semana</p>
            </div>
        </div>
        <div class="row g-3" id="lista-productos-publica">
            <div id="loading-products" class="col-12 text-center py-5">
                <div class="spinner-border" style="color: var(--color-primario);"></div>
                <p class="mt-2">Cargando productos...</p>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 text-muted border-top mt-4">
        <p class="mb-0">&copy; 2024 Mishell Boutique.</p>
    </footer>
    
    <div class="toast-container position-fixed top-0 start-0 p-3">
      <div id="liveToast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-body">Mensaje.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--color-primario-claro); color: var(--color-primario);">
                    <h1 class="modal-title fs-5" id="product-modal-title">Producto</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <img src="" id="product-modal-img" style="width: 100%; height: 400px; object-fit: contain; background-color: #fff;" alt="Producto">
                        </div>
                        <div class="col-md-6 d-flex flex-column">
                            <p id="product-modal-desc">Descripci√≥n...</p>
                            <div class="mt-auto">
                                <p class="mb-0" style="font-size: 1.5rem; font-weight: bold; color: var(--color-primario);" id="product-modal-price-detal">$0</p>
                                <p style="font-size: 1rem; color: #6c757d;" id="product-modal-price-mayor">Mayor: $0</p>
                                <input type="hidden" id="product-modal-id">
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label for="select-talla" class="form-label">Talla:</label>
                                        <select class="form-select" id="select-talla" required>
                                            <option value="">Selecciona...</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label for="select-color" class="form-label">Color:</label>
                                        <select class="form-select" id="select-color" required disabled>
                                            <option value="">Primero selecciona talla</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label for="select-cantidad" class="form-label mb-0">Cantidad:</label>
                                    <input type="number" class="form-control w-50" id="select-cantidad" value="1" min="1" max="1">
                                    <span id="stock-disponible" class="text-muted"></span>
                                </div>
                                <button class="btn btn-primary w-100" id="btn-add-to-cart" disabled>
                                    <i class="bi bi-bag-plus-fill me-2"></i>Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header" style="background-color: var(--color-primario-claro); color: var(--color-primario);">
            <h5 class="offcanvas-title"><i class="bi bi-bag me-2"></i>Mi Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cart-items-container">
                <p class="text-center text-muted" id="cart-empty-msg">Tu carrito est√° vac√≠o.</p>
            </div>
        </div>
        <div class="border-top p-3" id="cart-footer" style="display: none;">
            <p class="d-flex justify-content-between fs-5 fw-bold">
                <span>Total:</span>
                <span id="cart-total">$0</span>
            </p>
            <button class="btn btn-primary w-100" id="btn-checkout" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                <i class="bi bi-bag-check-fill me-2"></i> Continuar Pedido
            </button>
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--color-primario-claro); color: var(--color-primario);">
                    <h1 class="modal-title fs-5">Finalizar Pedido</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-checkout">
                        <div class="mb-3">
                            <label for="checkout-nombre" class="form-label">Nombre Completo:</label>
                            <input type="text" class="form-control" id="checkout-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-whatsapp" class="form-label">WhatsApp:</label>
                            <input type="tel" class="form-control" id="checkout-whatsapp" placeholder="3001234567" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-direccion" class="form-label">Direcci√≥n de Env√≠o:</label>
                            <input type="text" class="form-control" id="checkout-direccion" required>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-observaciones" class="form-label">Observaciones:</label>
                            <textarea class="form-control" id="checkout-observaciones" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="checkout-pago" class="form-label">M√©todo de Pago:</label>
                            <select class="form-select" id="checkout-pago" required>
                                <option value="">Selecciona...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                    <button type="submit" class="btn btn-primary" id="btn-confirm-order" form="form-checkout">
                        <i class="bi bi-whatsapp me-2"></i>Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBB55I4aWpH5hOtqK6FdNzZCuYCRm1siiI",
            authDomain: "mishell-boutique-admin.firebaseapp.com",
            projectId: "mishell-boutique-admin",
            storageBucket: "mishell-boutique-admin.firebasestorage.app",
            messagingSenderId: "399662956877",
            appId: "1:399662956877:web:084236f5bb3cf6f0a8f704"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productsCollection = collection(db, 'productos');
        const webOrdersCollection = collection(db, 'pedidosWeb');
        const formatoMoneda = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0});

        let bsToast = null;
        function showToast(message, type = 'success') {
            const liveToastEl = document.getElementById('liveToast');
            const toastBodyEl = document.getElementById('toast-body');
            if (liveToastEl && toastBodyEl) {
                if (!bsToast) { bsToast = new bootstrap.Toast(liveToastEl, { delay: 4000 }); }
                liveToastEl.className = 'toast align-items-center border-0';
                const bgClass = type === 'error' ? 'text-bg-danger' : (type === 'warning' ? 'text-bg-warning' : 'text-bg-success');
                liveToastEl.classList.add(bgClass, 'text-white');
                toastBodyEl.innerHTML = `<i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-2"></i> ${message}`;
                bsToast.show();
            }
        }

        const productListContainer = document.getElementById('lista-productos-publica');
        const loadingEl = document.getElementById('loading-products');
        const productDetailModalEl = document.getElementById('productDetailModal');
        const productModal = new bootstrap.Modal(productDetailModalEl);
        const modalTitle = document.getElementById('product-modal-title');
        const modalImg = document.getElementById('product-modal-img');
        const modalDesc = document.getElementById('product-modal-desc');
        const modalPriceDetal = document.getElementById('product-modal-price-detal');
        const modalPriceMayor = document.getElementById('product-modal-price-mayor');
        const modalIdInput = document.getElementById('product-modal-id');
        const selectTalla = document.getElementById('select-talla');
        const selectColor = document.getElementById('select-color');
        const selectCantidad = document.getElementById('select-cantidad');
        const stockDisponible = document.getElementById('stock-disponible');
        const btnAddToCart = document.getElementById('btn-add-to-cart');
        
        let cart = [];
        let productsMap = new Map();
        const cartOffcanvasEl = document.getElementById('cartOffcanvas');
        const cartOffcanvas = new bootstrap.Offcanvas(cartOffcanvasEl);
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartFooter = document.getElementById('cart-footer');
        const cartTotalEl = document.getElementById('cart-total');
        const cartBadge = document.getElementById('cart-badge');
        const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
        const formCheckout = document.getElementById('form-checkout');

        const renderProducts = (snapshot) => {
            if (!productListContainer) return;
            productListContainer.innerHTML = ''; 
            productsMap.clear();
            if (loadingEl) loadingEl.style.display = 'none';
            if (snapshot.empty) {
                productListContainer.innerHTML = '<p class="text-center text-muted">No hay productos disponibles.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const product = doc.data();
                const id = doc.id;
                productsMap.set(id, product);
                const stockTotal = (product.variaciones || []).reduce((sum, v) => sum + (parseInt(v.stock, 10) || 0), 0);
                const isAgotado = stockTotal <= 0;
                const imagenUrl = product.imagenUrl || 'https://via.placeholder.com/300x300/f0f0f0/ccc?text=Foto';
                
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3';
                col.innerHTML = `
                    <div class="card product-card h-100 ${isAgotado ? 'agotado' : ''}" data-bs-toggle="modal" data-bs-target="#productDetailModal" data-product-id="${id}">
                        ${isAgotado ? '<span class="badge bg-dark position-absolute top-0 end-0 m-2">Agotado</span>' : ''}
                        <img src="${imagenUrl}" class="card-img-top" alt="${product.nombre}">
                        <div class="card-body">
                            <h5 class="card-title" style="font-size: 0.9rem;">${product.nombre}</h5>
                            <p class="mb-0" style="color: var(--color-primario); font-weight: bold;">${formatoMoneda.format(product.precioDetal)}</p>
                        </div>
                    </div>
                `;
                productListContainer.appendChild(col);
            });
        };

        productDetailModalEl.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const productId = button.closest('[data-product-id]').dataset.productId;
            const product = productsMap.get(productId);
            if (!product) return;

            modalTitle.textContent = product.nombre;
            modalImg.src = product.imagenUrl || 'https://via.placeholder.com/400x400/f0f0f0/ccc?text=Foto';
            modalDesc.textContent = product.descripcion || 'Sin descripci√≥n.';
            modalPriceDetal.textContent = formatoMoneda.format(product.precioDetal);
            modalPriceMayor.textContent = `Mayor: ${formatoMoneda.format(product.precioMayor)}`;
            modalIdInput.value = productId;
            
            selectTalla.innerHTML = '<option value="">Selecciona...</option>';
            selectColor.innerHTML = '<option value="">Selecciona Color</option>';
            selectColor.disabled = true;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            selectCantidad.value = 1;

            const variaciones = product.variaciones || [];
            const tallasUnicas = [...new Set(variaciones.map(v => v.talla).filter(Boolean))];
            
            if (tallasUnicas.length === 0 && variaciones.length > 0) {
                selectTalla.innerHTML = '<option value="unica">√önica</option>';
                selectTalla.value = "unica";
            } else {
                tallasUnicas.forEach(talla => {
                    selectTalla.innerHTML += `<option value="${talla}">${talla}</option>`;
                });
            }

            const coloresUnicos = [...new Set(variaciones.map(v => v.color).filter(Boolean))];
            if (coloresUnicos.length === 0 && variaciones.length > 0) {
                selectColor.innerHTML = '<option value="unico">√önico</option>';
                selectColor.value = "unico";
                selectColor.disabled = false;
                selectColor.dispatchEvent(new Event('change'));
            } else if (tallasUnicas.length === 0) {
                selectTalla.dispatchEvent(new Event('change'));
            }
        });

        selectTalla.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla) return;

            selectColor.innerHTML = '<option value="">Selecciona...</option>';
            selectColor.disabled = false;
            stockDisponible.textContent = '';
            btnAddToCart.disabled = true;
            
            const variaciones = product.variaciones || [];
            const coloresParaTalla = [...new Set(variaciones
                .filter(v => (v.talla || 'unica') === selectedTalla)
                .map(v => v.color)
                .filter(Boolean)
            )];

            if (coloresParaTalla.length === 0) {
                selectColor.innerHTML = '<option value="unico">√önico</option>';
                selectColor.value = "unico";
                selectColor.dispatchEvent(new Event('change'));
            } else {
                coloresParaTalla.forEach(color => {
                    selectColor.innerHTML += `<option value="${color}">${color}</option>`;
                });
            }
        });

        selectColor.addEventListener('change', () => {
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const product = productsMap.get(modalIdInput.value);
            if (!product || !selectedTalla || !selectedColor) return;
            
            const variaciones = product.variaciones || [];
            const variacion = variaciones.find(v => 
                (v.talla || 'unica') === selectedTalla && 
                (v.color || 'unico') === selectedColor
            );
            
            if (variacion && variacion.stock > 0) {
                stockDisponible.textContent = `${variacion.stock} disponibles`;
                stockDisponible.className = "text-success";
                selectCantidad.max = variacion.stock;
                selectCantidad.value = 1;
                btnAddToCart.disabled = false;
            } else {
                stockDisponible.textContent = 'Agotado';
                stockDisponible.className = "text-danger";
                selectCantidad.max = 0;
                selectCantidad.value = 0;
                btnAddToCart.disabled = true;
            }
        });
        
        function addToCart(e) {
            e.preventDefault(); 
            const product = productsMap.get(modalIdInput.value);
            const selectedTalla = selectTalla.value;
            const selectedColor = selectColor.value;
            const cantidad = parseInt(selectCantidad.value, 10);
            
            if (!product || !selectedTalla || !selectedColor || cantidad <= 0) {
                showToast("Por favor selecciona talla, color y cantidad.", 'warning');
                return;
            }
            
            const cartItemId = `${product.id}-${selectedTalla}-${selectedColor}`;
            const existingItem = cart.find(item => item.cartItemId === cartItemId);
            
            if (existingItem) {
                existingItem.cantidad += cantidad;
                existingItem.total = existingItem.cantidad * existingItem.precio;
            } else {
                cart.push({
                    cartItemId: cartItemId,
                    id: product.id,
                    codigo: product.codigo || '',
                    nombre: product.nombre,
                    precio: product.precioDetal, 
                    talla: selectedTalla === 'unica' ? '√önica' : selectedTalla,
                    color: selectedColor === 'unico' ? '√önico' : selectedColor,
                    cantidad: cantidad,
                    total: cantidad * product.precioDetal,
                    imagenUrl: product.imagenUrl || ''
                });
            }
            
            showToast(`${product.nombre} a√±adido al carrito!`, 'success');
            productModal.hide();
            renderCart();
            cartOffcanvas.show();
        }
        
        function renderCart() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-muted">Tu carrito est√° vac√≠o.</p>';
                cartFooter.style.display = 'none';
                cartBadge.style.display = 'none';
            } else {
                cartFooter.style.display = 'block';
                cartItemsContainer.innerHTML = '';
                let totalGeneral = 0;
                let itemCount = 0;
                
                cart.forEach((item, index) => {
                    const imgUrl = item.imagenUrl || 'https://via.placeholder.com/50x65';
                    cartItemsContainer.innerHTML += `
                        <div class="d-flex align-items-center mb-3">
                            <img src="${imgUrl}" alt="${item.nombre}" style="width: 50px; height: 65px; object-fit: cover; border-radius: 0.25rem;" class="me-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">${item.nombre}</h6>
                                <small class="text-muted">${item.talla} / ${item.color}</small><br>
                                <span class="fw-bold">${formatoMoneda.format(item.precio)} x ${item.cantidad}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger btn-remove-from-cart" data-index="${index}">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    `;
                    totalGeneral += item.total;
                    itemCount += item.cantidad;
                });
                
                cartTotalEl.textContent = formatoMoneda.format(totalGeneral);
                cartBadge.textContent = itemCount;
                cartBadge.style.display = 'block';
            }
        }
        
        function clearCart() {
            cart = [];
            renderCart();
        }

        btnAddToCart.addEventListener('click', addToCart);

        cartItemsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.btn-remove-from-cart');
            if (target) {
                e.preventDefault();
                const index = parseInt(target.dataset.index, 10);
                cart.splice(index, 1);
                renderCart();
            }
        });
        
        if (formCheckout) {
            formCheckout.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btnConfirm = document.getElementById('btn-confirm-order');
                const originalText = btnConfirm.innerHTML;
                btnConfirm.disabled = true;
                btnConfirm.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                
                const nombre = document.getElementById('checkout-nombre').value.trim();
                const whatsapp = document.getElementById('checkout-whatsapp').value.trim();
                const direccion = document.getElementById('checkout-direccion').value.trim();
                const observaciones = document.getElementById('checkout-observaciones').value.trim();
                const pago = document.getElementById('checkout-pago').value;
                
                if (!nombre || !whatsapp || !direccion || !pago) {
                    showToast("Por favor completa todos los campos obligatorios.", 'warning');
                    btnConfirm.disabled = false;
                    btnConfirm.innerHTML = originalText;
                    return;
                }
                
                const totalGeneral = cart.reduce((sum, item) => sum + item.total, 0);

                const pedidoData = {
                    clienteNombre: nombre,
                    clienteCelular: whatsapp,
                    clienteDireccion: direccion,
                    observaciones: observaciones || '',
                    metodoPagoSolicitado: pago,
                    items: cart.map(item => ({
                        productoId: item.id || '',
                        codigo: item.codigo || '',
                        nombre: item.nombre || '',
                        talla: item.talla || '',
                        color: item.color || '',
                        cantidad: item.cantidad || 0,
                        precio: item.precio || 0,
                        total: item.total || 0
                    })),
                    totalPedido: totalGeneral,
                    estado: "pendiente",
                    timestamp: serverTimestamp(),
                    origen: "web"
                };

                try {
                    const docRef = await addDoc(webOrdersCollection, pedidoData);
                    console.log("Pedido guardado:", docRef.id);
                    
                    let mensaje = "¬°Hola Mishell Boutique! üëã\n\n";
                    mensaje += "Pedido desde tu cat√°logo web:\n\n";
                    mensaje += "*üì¶ PEDIDO #" + docRef.id.substring(0, 8).toUpperCase() + "*\n\n";
                    mensaje += "*DATOS DE ENTREGA:*\n";
                    mensaje += `üë§ ${nombre}\n`;
                    mensaje += `üì± ${whatsapp}\n`;
                    mensaje += `üìç ${direccion}\n`;
                    if(observaciones) mensaje += `üìù ${observaciones}\n`;
                    mensaje += `üí≥ ${pago}\n\n`;
                    mensaje += "*PRODUCTOS:*\n\n";

                    cart.forEach((item, index) => {
                        mensaje += `${index + 1}. *${item.nombre}*\n`;
                        mensaje += `   üìè ${item.talla} | üé® ${item.color}\n`;
                        mensaje += `   üî¢ ${item.cantidad}\n`;
                        mensaje += `   üí∞ ${formatoMoneda.format(item.precio)} x ${item.cantidad} = ${formatoMoneda.format(item.total)}\n\n`;
                    });
                    
                    mensaje += `\n*üíµ TOTAL: ${formatoMoneda.format(totalGeneral)}*\n\n`;
                    mensaje += `_Este pedido est√° en revisi√≥n._ ‚ú®`;
                    
                    const url = `https://wa.me/573046084971?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, '_blank');
                    
                    checkoutModal.hide();
                    cartOffcanvas.hide();
                    clearCart();
                    formCheckout.reset();
                    showToast("‚úÖ ¬°Pedido enviado! Te contactaremos pronto.", 'success');
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (err) {
                    console.error("Error:", err);
                    showToast("‚ùå Error al procesar tu pedido.", 'error');
                } finally {
                    btnConfirm.disabled = false;
                    btnConfirm.innerHTML = originalText;
                }
            });
        }

        const q = query(productsCollection, where("visible", "==", true), orderBy("timestamp", "desc"));
        onSnapshot(q, renderProducts, (error) => {
            console.error("Error:", error);
            if (loadingEl) loadingEl.style.display = 'none';
            productListContainer.innerHTML = `<p class="text-center text-danger">Error al cargar productos.</p>`;
        });

    </script>
</body>
</html>
