<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Super Admin - Plataforma Multi-Tenant</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="src/styles/theme.css">
  <link rel="stylesheet" href="admin-styles.css">

  <style>
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
    }

    .stat-card p {
      margin: 0;
      opacity: 0.9;
    }

    .tenant-card {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .tenant-card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-left-color: var(--color-primario);
    }

    .tenant-card.activo { border-left-color: #28a745; }
    .tenant-card.trial { border-left-color: #ffc107; }
    .tenant-card.suspendido { border-left-color: #dc3545; }

    .badge-estado {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
    }

    .navbar-super-admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 0;
    }

    .navbar-super-admin .navbar-brand {
      color: white;
      font-weight: 700;
      font-size: 1.5rem;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar-super-admin">
    <div class="container-fluid">
      <span class="navbar-brand">
        <i class="bi bi-shield-check"></i> PANEL SUPER ADMIN
      </span>
      <div class="d-flex align-items-center text-white">
        <span class="me-3">
          <strong data-user-name>Super Admin</strong>
          <small class="d-block" data-user-email>admin@plataforma.com</small>
        </span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Salir
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2">
        <div class="list-group">
          <a href="#dashboard" class="list-group-item list-group-item-action active" data-bs-toggle="pill">
            <i class="bi bi-speedometer2"></i> Dashboard
          </a>
          <a href="#tenants" class="list-group-item list-group-item-action" data-bs-toggle="pill">
            <i class="bi bi-shop"></i> Tenants
          </a>
          <a href="#planes" class="list-group-item list-group-item-action" data-bs-toggle="pill">
            <i class="bi bi-card-list"></i> Planes
          </a>
          <a href="#usuarios-global" class="list-group-item list-group-item-action" data-bs-toggle="pill">
            <i class="bi bi-people"></i> Usuarios
          </a>
          <a href="#logs" class="list-group-item list-group-item-action" data-bs-toggle="pill">
            <i class="bi bi-journal-text"></i> Audit Logs
          </a>
        </div>
      </div>

      <!-- Contenido Principal -->
      <div class="col-lg-10">
        <div class="tab-content">

          <!-- Dashboard -->
          <div class="tab-pane fade show active" id="dashboard">
            <h2 class="mb-4">Dashboard Global</h2>

            <!-- Estadísticas -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="stat-card">
                  <h3 id="stat-tenants-activos">0</h3>
                  <p>Tenants Activos</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  <h3 id="stat-total-productos">0</h3>
                  <p>Productos Totales</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                  <h3 id="stat-total-usuarios">0</h3>
                  <p>Usuarios Totales</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                  <h3 id="stat-total-ventas">0</h3>
                  <p>Ventas Totales</p>
                </div>
              </div>
            </div>

            <!-- Gráficos (Placeholder) -->
            <div class="card">
              <div class="card-header">
                <h5>Actividad de la Plataforma</h5>
              </div>
              <div class="card-body">
                <p class="text-muted">Aquí puedes agregar gráficos con Chart.js o similar</p>
              </div>
            </div>
          </div>

          <!-- Tenants -->
          <div class="tab-pane fade" id="tenants">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Gestión de Tenants</h2>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearTenant">
                <i class="bi bi-plus-circle"></i> Crear Nuevo Tenant
              </button>
            </div>

            <!-- Filtros -->
            <div class="card mb-3">
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-4">
                    <input type="text" id="buscar-tenant" class="form-control" placeholder="Buscar por nombre o slug...">
                  </div>
                  <div class="col-md-3">
                    <select id="filtro-estado" class="form-select">
                      <option value="">Todos los estados</option>
                      <option value="activo">Activos</option>
                      <option value="trial">Trial</option>
                      <option value="suspendido">Suspendidos</option>
                      <option value="cancelado">Cancelados</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select id="filtro-plan" class="form-select">
                      <option value="">Todos los planes</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="cargarTenants()">
                      <i class="bi bi-search"></i> Buscar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Lista de Tenants -->
            <div id="lista-tenants">
              <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Cargando tenants...</p>
              </div>
            </div>
          </div>

          <!-- Planes -->
          <div class="tab-pane fade" id="planes">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Gestión de Planes</h2>
              <button class="btn btn-primary" onclick="abrirModalPlan()">
                <i class="bi bi-plus-circle"></i> Crear Nuevo Plan
              </button>
            </div>

            <div id="lista-planes"></div>
          </div>

          <!-- Usuarios Global -->
          <div class="tab-pane fade" id="usuarios-global">
            <h2 class="mb-4">Todos los Usuarios de la Plataforma</h2>

            <div class="card">
              <div class="card-body">
                <p>Vista global de todos los usuarios de todos los tenants</p>
                <div id="lista-usuarios-global"></div>
              </div>
            </div>
          </div>

          <!-- Audit Logs -->
          <div class="tab-pane fade" id="logs">
            <h2 class="mb-4">Audit Logs</h2>

            <div class="card">
              <div class="card-body">
                <p>Registro de todas las acciones críticas en la plataforma</p>
                <div id="lista-logs"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Crear Tenant -->
  <div class="modal fade" id="modalCrearTenant" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nuevo Tenant</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="form-crear-tenant">
            <div class="mb-3">
              <label class="form-label">Nombre de la Empresa *</label>
              <input type="text" class="form-control" id="tenant-nombre" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Slug (subdominio) *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="tenant-slug" required pattern="[a-z0-9-]+">
                <span class="input-group-text">.miboutique.com</span>
              </div>
              <small class="text-muted">Solo letras minúsculas, números y guiones</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Plan *</label>
              <select class="form-select" id="tenant-plan" required>
                <option value="">Seleccionar plan...</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Email del Administrador *</label>
              <input type="email" class="form-control" id="tenant-admin-email" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Nombre del Administrador *</label>
              <input type="text" class="form-control" id="tenant-admin-nombre" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Contraseña Temporal *</label>
              <input type="password" class="form-control" id="tenant-admin-password" required minlength="6">
              <small class="text-muted">El admin deberá cambiarla en su primer login</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="crearTenant()">Crear Tenant</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <!-- Módulos Multi-Tenant -->
  <script src="src/core/firebase-config.js"></script>
  <script src="src/core/tenant-resolver.js"></script>
  <script src="src/core/auth-manager.js"></script>
  <script src="src/core/permissions.js"></script>
  <script src="src/services/tenants.service.js"></script>
  <script src="src/core/app-init.js"></script>

  <script>
    // ============================================================
    // INICIALIZACIÓN
    // ============================================================

    window.onAppReady(async () => {
      // Verificar que es Super Admin
      if (!window.appContext.isSuperAdmin) {
        alert('⛔ Acceso denegado. Solo Super Admins pueden acceder a este panel.');
        window.location.href = '/admin.html';
        return;
      }

      console.log('✅ Panel Super Admin listo');

      // Cargar datos iniciales
      await cargarDashboard();
      await cargarTenants();
      await cargarPlanes();
    });

    // ============================================================
    // DASHBOARD
    // ============================================================

    async function cargarDashboard() {
      try {
        const stats = await window.tenantsService.obtenerEstadisticasGlobales();

        document.getElementById('stat-tenants-activos').textContent = stats.tenantsActivos;
        document.getElementById('stat-total-productos').textContent = stats.totalProductos.toLocaleString();
        document.getElementById('stat-total-usuarios').textContent = stats.totalUsuarios.toLocaleString();
        document.getElementById('stat-total-ventas').textContent = stats.totalVentas.toLocaleString();

      } catch (error) {
        console.error('Error al cargar dashboard:', error);
      }
    }

    // ============================================================
    // TENANTS
    // ============================================================

    async function cargarTenants() {
      try {
        const estado = document.getElementById('filtro-estado')?.value;
        const plan = document.getElementById('filtro-plan')?.value;
        const busqueda = document.getElementById('buscar-tenant')?.value;

        const filtros = {};
        if (estado) filtros.estado = estado;
        if (plan) filtros.planId = plan;

        let tenants = await window.tenantsService.listar(filtros);

        // Filtrar por búsqueda en cliente
        if (busqueda) {
          const busquedaLower = busqueda.toLowerCase();
          tenants = tenants.filter(t =>
            t.nombre.toLowerCase().includes(busquedaLower) ||
            t.slug.toLowerCase().includes(busquedaLower)
          );
        }

        renderizarTenants(tenants);

      } catch (error) {
        console.error('Error al cargar tenants:', error);
        document.getElementById('lista-tenants').innerHTML = `
          <div class="alert alert-danger">Error al cargar tenants: ${error.message}</div>
        `;
      }
    }

    function renderizarTenants(tenants) {
      const container = document.getElementById('lista-tenants');

      if (tenants.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            No se encontraron tenants con los filtros seleccionados
          </div>
        `;
        return;
      }

      const html = tenants.map(tenant => `
        <div class="card tenant-card ${tenant.estado} mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="mb-1">${tenant.nombre}</h5>
                <p class="text-muted mb-1">
                  <i class="bi bi-link-45deg"></i> ${tenant.slug}.miboutique.com
                </p>
                <span class="badge badge-estado bg-${getEstadoColor(tenant.estado)}">
                  ${tenant.estado}
                </span>
                <span class="badge bg-secondary ms-2">${tenant.planId}</span>
              </div>
              <div class="col-md-3">
                <small class="text-muted d-block">Productos: ${tenant.estadisticas?.totalProductos || 0}</small>
                <small class="text-muted d-block">Usuarios: ${tenant.estadisticas?.totalUsuarios || 0}</small>
                <small class="text-muted d-block">Ventas: ${tenant.estadisticas?.totalVentas || 0}</small>
              </div>
              <div class="col-md-3 text-end">
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary" onclick="editarTenant('${tenant.id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  ${tenant.estado === 'activo' ?
                    `<button class="btn btn-sm btn-outline-warning" onclick="suspenderTenant('${tenant.id}')">
                      <i class="bi bi-pause-circle"></i>
                    </button>` :
                    tenant.estado === 'suspendido' ?
                    `<button class="btn btn-sm btn-outline-success" onclick="activarTenant('${tenant.id}')">
                      <i class="bi bi-play-circle"></i>
                    </button>` : ''
                  }
                  <button class="btn btn-sm btn-outline-secondary" onclick="verDetallesTenant('${tenant.id}')">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function getEstadoColor(estado) {
      const colores = {
        activo: 'success',
        trial: 'warning',
        suspendido: 'danger',
        cancelado: 'secondary'
      };
      return colores[estado] || 'secondary';
    }

    async function crearTenant() {
      try {
        const datos = {
          nombre: document.getElementById('tenant-nombre').value,
          slug: document.getElementById('tenant-slug').value,
          planId: document.getElementById('tenant-plan').value,
          contacto: {
            email: document.getElementById('tenant-admin-email').value
          }
        };

        // Validar slug
        if (!/^[a-z0-9-]+$/.test(datos.slug)) {
          alert('El slug solo puede contener letras minúsculas, números y guiones');
          return;
        }

        // Crear tenant
        const tenantId = await window.tenantsService.crear(datos);

        // Crear usuario admin para el tenant
        const adminEmail = document.getElementById('tenant-admin-email').value;
        const adminPassword = document.getElementById('tenant-admin-password').value;
        const adminNombre = document.getElementById('tenant-admin-nombre').value;

        // TODO: Crear usuario admin (necesitarías una Cloud Function para esto)

        alert(`✅ Tenant creado correctamente: ${datos.nombre}`);

        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalCrearTenant')).hide();

        // Recargar lista
        await cargarTenants();

      } catch (error) {
        console.error('Error al crear tenant:', error);
        alert('❌ ' + error.message);
      }
    }

    async function suspenderTenant(tenantId) {
      const motivo = prompt('¿Por qué deseas suspender este tenant?');
      if (!motivo) return;

      try {
        await window.tenantsService.suspender(tenantId, motivo);
        alert('✅ Tenant suspendido');
        await cargarTenants();
      } catch (error) {
        alert('❌ ' + error.message);
      }
    }

    async function activarTenant(tenantId) {
      if (!confirm('¿Activar este tenant?')) return;

      try {
        await window.tenantsService.activar(tenantId);
        alert('✅ Tenant activado');
        await cargarTenants();
      } catch (error) {
        alert('❌ ' + error.message);
      }
    }

    function editarTenant(tenantId) {
      // TODO: Implementar modal de edición
      alert('Función de edición en desarrollo');
    }

    function verDetallesTenant(tenantId) {
      // TODO: Implementar vista de detalles
      alert('Función de detalles en desarrollo');
    }

    // ============================================================
    // PLANES
    // ============================================================

    async function cargarPlanes() {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('planes').orderBy('orden', 'asc').get();

        const planes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Llenar select de planes en modal crear tenant
        const selectPlan = document.getElementById('tenant-plan');
        const selectFiltroPlan = document.getElementById('filtro-plan');

        planes.forEach(plan => {
          selectPlan.innerHTML += `<option value="${plan.id}">${plan.nombre} - $${plan.precio} ${plan.periodo}</option>`;
          selectFiltroPlan.innerHTML += `<option value="${plan.id}">${plan.nombre}</option>`;
        });

        // Renderizar en tab de planes
        renderizarPlanes(planes);

      } catch (error) {
        console.error('Error al cargar planes:', error);
      }
    }

    function renderizarPlanes(planes) {
      const container = document.getElementById('lista-planes');

      const html = planes.map(plan => `
        <div class="card mb-3">
          <div class="card-body">
            <h5>${plan.nombre}</h5>
            <p class="text-muted">$${plan.precio} / ${plan.periodo}</p>
            <ul>
              <li>Productos: ${plan.limites.maxProductos}</li>
              <li>Usuarios: ${plan.limites.maxUsuarios}</li>
              <li>Storage: ${(plan.limites.maxStorage / 1024 / 1024).toFixed(0)} MB</li>
            </ul>
            <button class="btn btn-sm btn-outline-primary" onclick="editarPlan('${plan.id}')">Editar</button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function abrirModalPlan() {
      alert('Función en desarrollo');
    }

    function editarPlan(planId) {
      alert('Función en desarrollo');
    }

    // ============================================================
    // LOGOUT
    // ============================================================

    async function logout() {
      if (confirm('¿Cerrar sesión?')) {
        await window.authManager.logout();
      }
    }
  </script>
</body>
</html>
